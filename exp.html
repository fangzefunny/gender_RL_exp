<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="jspsych-6.3.1/jspsych.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-survey-html-form.js"></script>
    <script src="jspsych-6.3.1/plugins/jspsych-fullscreen.js"></script>
    <link href="jspsych-6.3.1/css/jspsych.css" rel="stylesheet" type="text/css"></link>

</head>
<body>
    <script>
        // 0. Hyperparameter, adjust it before creating each experiement 

        // Experiment contents: 
        // prac_stage: 
        prac_repetitions = 1; // repetitions of each image 
        var prac_stim_space = [ 'img/men1.png', 'img/women1.png'] // load the presented stimuli 
        var prac_correct_acts = [ 'j', 'f']
        // main_stage:
        main_repetitions = 2; // repetitions of each image 
        var main_stim_space = [ 'img/men1.png', 'img/women1.png', 'img/men2.png', 'img/women2.png',
                                'img/men3.png', 'img/women3.png', 'img/men4.png', 'img/women4.png',
                                'img/men5.png', 'img/women5.png', 'img/men6.png', 'img/women6.png']  
        var main_correct_acts = [ 'j', 'f', 'j', 'f', 'j', 'f', 'j', 'f', 'j', 'f', 'j', 'f']       

        // presented time: 
        fixation_dura = 1000; // ms
        feedback_dura = 1000; // ms of feedback 
        post_feedback_dura = 500

        // feedback content 
        correct_feedback  = '你答对了！+1';
        incorrect_feedback = '你答错了! +0';
       
        // 1. Utility function to faciliate the experiment presentation 

        // define an shuffle function
        function shuffle_array(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array 
        };

        // define the function to prep experiment materials
        function prep_material ( repetitions, stim_space, correct_acts) {
            var correct_acts_seq = [];
            var stimuli_seq = [];
            for (var r = 0; r < repetitions; r++){
                var mini_block = [];
                for ( var i = 0; i < stim_space.length; i++){
                    mini_block.push( i)
                    mini_block = shuffle_array(mini_block)
                    for ( var j = 0; j < mini_block.length; j++){
                        stimuli_seq = stimuli_seq.concat( stim_space[ mini_block[j]])
                        correct_acts_seq = correct_acts_seq.concat( correct_acts[ mini_block[j]])
                    }
                }
            }
            return {stimuli_seq:stimuli_seq, correct_acts_seq:correct_acts_seq}
        };

        function load_stim (stimuli_seq, correct_acts_seq) {
            var time_var = [] 
            for (var i = 0; i < stimuli_seq.length; i++) {
                time_var.push({pic: stimuli_seq[i],
                               correct_act: correct_acts_seq[i]});
            };
            return time_var
        }

        // function get_data( csv, fname){
        //     var csvfile;
        //     var downloadlink;

        //     csv = new Blob( blobParts:[csv], )

        // }
        
        // 2. Prepare all screens 

        // 2.1 Welcome screen 
        var demograph = {
            data: { screen_id: 'demo'},
            type: "survey-html-form",
            preamble: '<p><span style="color: black; font-size: 40px">\
                        麻烦完成一下的信息录入：</p>',
            html: "<p>性别(男或女): <input name='Gender' type='text'/></p>",
            button_label: '继续',
            on_finish: function (trialdata) {
                trialdata.response = JSON.parse( trialdata.response);
                jsPsych.trialdata.addProperties({
                    gender: trialdata.response.Gender,
                    age: trialdata.response.age,
                })
            }
        };

        var welcome = {
            type: "fullscreen",
            fullscreen_mode: true,
            message: '<p><span style="color: black; font-size: 40px">\
                        欢迎来到本实验。<br><br>\
                        以下实验需要全屏模式。<br><br>\
                        按键开始实验</p>',
            button_label: '进入全屏模式开始实验',
            on_finish: function () {
                var bodyNode = document.getElementsByTagName("body");
                for (let i = 0; i < bodyNode.length; i++) {
                    bodyNode[i].style.cursor = "none";
                }
            }
        };

        // 2.2 General instruction screen
        var instructions = {
            type: "html-keyboard-response",
            stimulus: '<span style="color: black; font-size: 40px">\
                        在这个实验中你们将学习使用一组船新的词汇，<br><br>\
                        这些词汇分别是用来评价男性或者女性的。<br><br>\
                        在这个实验中，你将为这个词汇填入其描述的主语来完成一个句子。<br><br>\
                        看不懂？没关系，按任意按键进入练习阶段。'
        };

        // 2.2.1 Practice instruction screen
        var prac_instruct = {
            type: "html-keyboard-response",
            stimulus: '<span style="color: black; font-size: 40px">\
                        现在进入练习阶段，<br><br>\
                        你需要达到正确率80%以上才可以进入主试验，<br><br>\
                        按任意按键开始练习。'
        };

        var main_instruct = {
            type: "html-keyboard-response",
            stimulus: '<span style="color: black; font-size: 40px">\
                        现在进入主实验阶段。从现在开始，<br><br>\
                        你回答的正确率将直接影响你的实验报酬，<br><br>\
                        按任意按键开始赚钱。'
        };

        // 2.3 Fixation screen
        var fixation = {
            type: 'html-keyboard-response',
            stimulus: '<span style="color: black; font-size: 100px">+',
            choices: jsPsych.NO_KEYS,
            trial_duration: fixation_dura,
        };

        // 2.4 Stimuli screen 
        var stim = {
            data: { screen_id: 'stim', 'correct_act': jsPsych.timelineVariable("correct_act")},
            type: "image-keyboard-response",
            stimulus: jsPsych.timelineVariable("pic"),
            choices: ['f', 'j'],
            trial_duration: null,
            on_finish: function (data) {
                // give the feedback to the subject 
                if (data.response == data.correct_act){
                    data.is_correct = 1.
                } else {
                    data.is_correct = 0.
                }
            }
        };
        
        // 2.5 Feedback screen
        var feedback = {
            data: { screen_id: 'feedback'},
            type: 'html-keyboard-response',
            stimulus: function(){
                var recent_trial_acc = jsPsych.data.get().last(1).values()[0].is_correct;
                if (recent_trial_acc == 1){
                    return correct_feedback
                } else {
                    return incorrect_feedback
                }
            },
            choices: jsPsych.NO_KEYS,
            trial_duration: feedback_dura,
            post_trial_gap: post_feedback_dura
        }

        // 3. Run the experiment process

        // Define the procedure 
        material = prep_material( prac_repetitions, prac_stim_space, prac_correct_acts)
        time_var = load_stim( material.stimuli_seq, material.correct_acts_seq)
        fname = document.location
        var procedure = {
            timeline: [fixation, stim, feedback],
            timeline_variables: time_var,
        };

        var timeline = [ demograph, welcome, instructions, procedure]
        jsPsych.init({
            timeline: timeline,
            on_finish: function () {
                jsPsych.data.get().localSave("csv", 'data.csv');
            }
        })
    </script>
</body>
</html>